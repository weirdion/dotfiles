#!/usr/bin/env bash

function _convertToMp4() {
    local newName="${1%.*}-new.mp4"
    local finalName="${1%.*}.mp4"
    # b:a 128k for audio bitrate
    # crf 23 to balance Constant Rate Factor (CRF) quality and file size
    # preset slow for better compression
    # movflags +faststart for better streaming support
    ffmpeg -i "$1" \
        -f mp4 \
        -c:v libx264 \
        -c:a aac \
        -b:a 128k \
        -crf 23 \
        -preset slow \
        -movflags +faststart \
        -loglevel error -stats \
        "$newName" -hide_banner && \
    rm -v "$1" && mv "$newName" "$finalName"
}

if [ "$#" -eq 1 ]; then
    _convertToMp4 "$1"
elif [ "$#" -gt 1 ]; then
    for f in "$@"; do
        echo "*** Processing $f ***"
        _convertToMp4 "$f"
    done
else
    echo -e  "\033[0;31mUnable to execute the command.\033[0m"
    echo -e  "\033[0;37mUsage: convertToMp4 source\033[0m"
fi
